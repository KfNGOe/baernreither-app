name: Build project
on:
  push:
    paths:      
      - "data/tei/text/**"
      - "data/xlsx/**"
      - "html/data/img/**"
  #workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build_pages:    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Perform Checkout
        uses: actions/checkout@v4
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: "11"
          distribution: "adopt"      
      - id: files
        uses: jitterbit/get-changed-files@v1      
      - name: Install
        run: |          
          chmod +x install.sh
          ./install.sh
      - name: Make dir
        run: |
          chmod +x setup_dir.sh
          ./setup_dir.sh
      - name: Start graphdb
        run: |
          chmod +x gdb_start.sh
          ./gdb_start.sh &
      - name: Wait for graphdb
        run: |
          chmod +x gdb_ping.sh
          ./gdb_ping.sh
        shell: bash
      - name: Create repo
        run: |
          chmod +x gdb_createRepo.sh
          ./gdb_createRepo.sh
      - name: Get repo list
        run: |
          chmod +x gdb_getRepo.sh
          ./gdb_getRepo.sh
      - name: running tei transform
        run: |
          chmod +x gh_tei2ttl.sh        
          ./gh_tei2ttl.sh
        env:
          changes: ${{ steps.files.outputs.all }}
      - name: build texts
        run: |
          chmod +x build_texts.sh                
          ./build_texts.sh
      - name: build register
        run: |
          chmod +x build_register.sh
          ./build_register.sh
      - name: build search
        run: |
          chmod +x build_ssSearch_all.sh
          ./build_ssSearch_all.sh
      - name: build html
        run: |
          chmod +x build_html.sh
          ./build_html.sh   
      - name: deploy html
        run: |
          chmod +x deploy_html.sh
          ./deploy_html.sh
      - name: push to repo
        run: |
          git config --global user.email "baernreither-app@github.io"
          git config --global user.name "KfNGOe"
          git status
          git add .
          git commit -am "Deploy data"
          git push https://${{ secrets.ACCESS_TOKEN }}@github.com/KfNGOe/baernreither-app main
      
      #- name: Setup pages
      #  uses: actions/configure-pages@v5
      #- name: Upload artifact
      #  uses: actions/upload-pages-artifact@v3
      #  with:
      #    # Upload html directory
      #    path: './html'
      #- name: Deploy to GitHub Pages
      #  id: deployment
      #  uses: actions/deploy-pages@v4